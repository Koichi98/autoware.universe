<?xml version="1.0" encoding="UTF-8"?>
<launch>
  <!-- Agnocast node environment configuration with custom mempool size -->
  <!-- This file is self-contained and can be included in any node_container launch file -->
  <!-- No arguments need to be passed from parent files (except custom mempool size) -->
  <!--
    Configuration:
    - Checks ENABLE_AGNOCAST environment variable (set to "1" to enable)
    - Uses default heaphook path: /opt/ros/humble/lib/libagnocast_heaphook.so
    - Custom mempool size can be specified via argument (default: 8GB)
  -->

  <!-- Argument for custom mempool size -->
  <arg name="agnocast_mempool_size" default="8589934592" description="Agnocast mempool size in bytes (default: 8GB)"/>

  <!-- Check ENABLE_AGNOCAST environment variable -->
  <let name="agnocast_heaphook_path" value="/opt/ros/humble/lib/libagnocast_heaphook.so"/>
  <let name="use_agnocast_flag" value="$(env ENABLE_AGNOCAST 0)"/>

  <!-- Configure LD_PRELOAD based on ENABLE_AGNOCAST flag -->
  <let name="ld_preload_value" value="$(var agnocast_heaphook_path):$(env LD_PRELOAD '')" if="$(eval &quot;'$(var use_agnocast_flag)' == '1'&quot;)"/>
  <let name="ld_preload_value" value="$(env LD_PRELOAD '')" unless="$(eval &quot;'$(var use_agnocast_flag)' == '1'&quot;)"/>

  <!-- Configure mempool size based on ENABLE_AGNOCAST flag -->
  <let name="mempool_size" value="$(var agnocast_mempool_size)" if="$(eval &quot;'$(var use_agnocast_flag)' == '1'&quot;)"/>
  <let name="mempool_size" value="0" unless="$(eval &quot;'$(var use_agnocast_flag)' == '1'&quot;)"/>
</launch>
